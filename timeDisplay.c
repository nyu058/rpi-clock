//author: Nathan Yu
#include <bcm2835.h>
#include <stdio.h>
#include <time.h>
#include <ctype.h>
#include <stdlib.h>
#include <string.h>
#define uchar unsigned char
#define uint unsigned int
#define Max7219_pinCS  RPI_GPIO_P1_24
uchar left[12][8] = { { 0B00000000, 0B00010000, 0B00110000, 0B00010001,
		0B00010000, 0B00010001, 0B00010000, 0B00111000 }, //1
		{ 0B00000000, 0B00110000, 0B01001000, 0B00001001, 0B00010000,
				0B00010001, 0B00100000, 0B01111000 }, //2
		{ 0B00000000, 0B00110000, 0B01001000, 0B00001001, 0B00110000,
				0B00001001, 0B01001000, 0B00110000 }, //3
		{ 0B00000000, 0B00001000, 0B00011000, 0B00101001, 0B01111000,
				0B00001001, 0B00001000, 0B00000000 }, //4
		{ 0B00000000, 0B01111000, 0B01000000, 0B01000001, 0B01111000,
				0B00001001, 0B00001000, 0B00110000 }, //5
		{ 0B00000000, 0B00110000, 0B01001000, 0B01000001, 0B01110000,
				0B01001001, 0B01001000, 0B00110000 }, //6
		{ 0B00000000, 0B01111000, 0B00001000, 0B00001001, 0B00010000,
				0B00010001, 0B00100000, 0B00100000 }, //7
		{ 0B00000000, 0B00110000, 0B01001000, 0B01001001, 0B00110000,
				0B01001001, 0B01001000, 0B00110000 }, //8
		{ 0B00000000, 0B00110000, 0B01001000, 0B01001001, 0B00111000,
				0B00001001, 0B00001000, 0B00110000 }, //9
		{ 0B00000000, 0B01001000, 0B11010100, 0B01010101, 0B01010100,
				0B01010101, 0B11101000, 0B00000000 }, //10
		{ 0B00000000, 0B01000100, 0B11001100, 0B01000101, 0B01000100,
				0B01000101, 0B11101110, 0B00000000 }, // 11
		{ 0B00000000, 0B01000100, 0B11001010, 0B01000011, 0B01000100,
				0B01001001, 0B11101110, 0B00000000 }, //12
		};
uchar leftB[12][8] = { { 0B00000000, 0B00010000, 0B00110000, 0B00010000,
		0B00010000, 0B00010000, 0B00010000, 0B00111000 }, //1
		{ 0B00000000, 0B00110000, 0B01001000, 0B00001000, 0B00010000,
				0B00010000, 0B00100000, 0B01111000 }, //2
		{ 0B00000000, 0B00110000, 0B01001000, 0B00001000, 0B00110000,
				0B00001000, 0B01001000, 0B00110000 }, //3
		{ 0B00000000, 0B00001000, 0B00011000, 0B00101000, 0B01111000,
				0B00001000, 0B00001000, 0B00000000 }, //4
		{ 0B00000000, 0B01111000, 0B01000000, 0B01000000, 0B01111000,
				0B00001000, 0B00001000, 0B00110000 }, //5
		{ 0B00000000, 0B00110000, 0B01001000, 0B01000000, 0B01110000,
				0B01001000, 0B01001000, 0B00110000 }, //6
		{ 0B00000000, 0B01111000, 0B00001000, 0B00001000, 0B00010000,
				0B00010000, 0B00100000, 0B00100000 }, //7
		{ 0B00000000, 0B00110000, 0B01001000, 0B01001000, 0B00110000,
				0B01001000, 0B01001000, 0B00110000 }, //8
		{ 0B00000000, 0B00110000, 0B01001000, 0B01001000, 0B00111000,
				0B00001000, 0B00001000, 0B00110000 }, //9
		{ 0B00000000, 0B01001000, 0B11010100, 0B01010100, 0B01010100,
				0B01010100, 0B11101000, 0B00000000 }, //10
		{ 0B00000000, 0B01000100, 0B11001100, 0B01000100, 0B01000100,
				0B01000100, 0B11101110, 0B00000000 }, // 11
		{ 0B00000000, 0B01000100, 0B11001010, 0B01000010, 0B01000100,
				0B01001000, 0B11101110, 0B00000000 }, //12
		};
uchar right[60][8] = { { 0B00000000, 0B01000100, 0B10101010, 0B10101010,
		0B10101010, 0B10101010, 0B01000100, 0B00000000 }, //00
		{ 0B00000000, 0B01000100, 0B10101100, 0B10100100, 0B10100100,
				0B10100100, 0B01001110, 0B00000000 }, //01
		{ 0B00000000, 0B01000100, 0B10101010, 0B10100010, 0B10100100,
				0B10101000, 0B01001110, 0B00000000 }, //02
		{ 0B00000000, 0B01001110, 0B10100010, 0B10100100, 0B10100010,
				0B10101010, 0B01000100, 0B00000000 }, //03
		{ 0B00000000, 0B01001010, 0B10101010, 0B10101010, 0B10101111,
				0B10100010, 0B01000010, 0B00000000 }, //04
		{ 0x00, 0x4E, 0xA8, 0xAE, 0xA1, 0xA9, 0x46, 0x00 }, //05
		{ 0x00, 0x46, 0xA8, 0xAE, 0xA9, 0xA9, 0x46, 0x00 }, //06
		{ 0x00, 0x4F, 0xA1, 0xA2, 0xA2, 0xA4, 0x44, 0x00 }, //07
		{ 0x00, 0x46, 0xA9, 0xA9, 0xA6, 0xA9, 0x49, 0x06 }, //08
		{ 0x00, 0x46, 0xA9, 0xA9, 0xA7, 0xA1, 0x46, 0x00 }, //09
		{ 0B00000000, 0B01001000, 0B11010100, 0B01010100, 0B01010100,
				0B01010100, 0B11101000, 0B00000000 }, //10
		{ 0B00000000, 0B01000100, 0B11001100, 0B01000100, 0B01000100,
				0B01000100, 0B11101110, 0B00000000 }, //11
		{ 0B00000000, 0B01000100, 0B11001010, 0B01000010, 0B01000100,
				0B01001000, 0B11101110, 0B00000000 }, //12
		{ 0x00, 0x4E, 0xC2, 0x44, 0x42, 0x4A, 0xE4, 0x00 }, //13
		{ 0x00, 0x4A, 0xCA, 0x4A, 0x4F, 0x42, 0xE2, 0x00 }, //14
		{ 0x00, 0x4F, 0xC8, 0x48, 0x4E, 0x41, 0xE9, 0x06 }, //15
		{ 0x00, 0x46, 0xC8, 0x48, 0x4E, 0x49, 0xE9, 0x06 }, //16
		{ 0x00, 0x4F, 0xC1, 0x42, 0x42, 0x44, 0xE4, 0x00 }, //17
		{ 0x00, 0x46, 0xC9, 0x49, 0x46, 0x49, 0xE9, 0x06 }, //18
		{ 0x00, 0x46, 0xC9, 0x49, 0x47, 0x41, 0xE1, 0x06 }, //19
		{ 0x00, 0x44, 0xAA, 0x2A, 0x4A, 0x8A, 0xE4, 0x00 }, //20
		{ 0x00, 0x44, 0xAC, 0x24, 0x44, 0x84, 0xEE, 0x00 }, //21
		{ 0x00, 0x44, 0xAA, 0x22, 0x44, 0x88, 0xEE, 0x00 }, //22
		{ 0x00, 0x4E, 0xA2, 0x24, 0x42, 0x8A, 0xE4, 0x00 }, //23
		{ 0x00, 0x4A, 0xAA, 0x2A, 0x4F, 0x82, 0xE2, 0x00 }, //24
		{ 0x00, 0x4E, 0xA8, 0x2E, 0x41, 0x89, 0xE6, 0x00 }, //25
		{ 0x00, 0x46, 0xA8, 0x28, 0x4E, 0x89, 0xE9, 0x06 }, //26
		{ 0x00, 0x4F, 0xA1, 0x22, 0x42, 0x84, 0xE4, 0x00 }, //27
		{ 0x00, 0x46, 0xA9, 0x29, 0x46, 0x89, 0xE9, 0x06 }, //28
		{ 0x00, 0x46, 0xA9, 0x29, 0x47, 0x81, 0xE1, 0x06 }, //29
		{ 0x00, 0xE4, 0x2A, 0x4A, 0x2A, 0xAA, 0x44, 0x00 }, //30
		{ 0x00, 0xE4, 0x2C, 0x44, 0x24, 0xA4, 0x4E, 0x00 }, //31
		{ 0x00, 0xE4, 0x2A, 0x42, 0x24, 0xA8, 0x4E, 0x00 }, //32
		{ 0x00, 0xEE, 0x22, 0x44, 0x22, 0xAA, 0x44, 0x00 }, //33
		{ 0x00, 0xEA, 0x2A, 0x4A, 0x2F, 0xA2, 0x42, 0x00 }, //34
		{ 0x00, 0xEE, 0x28, 0x4E, 0x21, 0xA9, 0x46, 0x00 }, //35
		{ 0x00, 0xE0, 0x26, 0x48, 0x2E, 0xA9, 0x49, 0x06 }, //36
		{ 0x00, 0xEF, 0x21, 0x42, 0x22, 0xA4, 0x44, 0x00 }, //37
		{ 0x00, 0xE6, 0x29, 0x49, 0x26, 0xA9, 0x49, 0x06 }, //38
		{ 0x00, 0xE6, 0x29, 0x49, 0x27, 0xA1, 0x46, 0x00 }, //39
		{ 0x00, 0xA6, 0xA9, 0xA9, 0xE9, 0x29, 0x26, 0x00 }, //40
		{ 0x00, 0xA4, 0xAC, 0xA4, 0xE4, 0x24, 0x2E, 0x00 }, //41
		{ 0x00, 0xA6, 0xA9, 0xA1, 0xE2, 0x24, 0x2F, 0x00 }, //42
		{ 0x00, 0xA6, 0xA9, 0xA1, 0xE2, 0x21, 0x29, 0x06 }, //43
		{ 0x00, 0xAA, 0xAA, 0xAA, 0xEE, 0x22, 0x22, 0x00 }, //44
		{ 0x00, 0xAE, 0xA8, 0xAE, 0xE1, 0x29, 0x26, 0x00 }, //45
		{ 0x00, 0xA6, 0xA8, 0xAE, 0xE9, 0x29, 0x26, 0x00 }, //46
		{ 0x00, 0xAF, 0xA1, 0xA2, 0xE2, 0x24, 0x24, 0x00 }, //47
		{ 0x00, 0xA6, 0xA9, 0xA9, 0xE6, 0x29, 0x29, 0x06 }, //48
		{ 0x00, 0xA6, 0xA9, 0xA9, 0xE7, 0x21, 0x26, 0x00 }, //49
		{ 0x00, 0xE6, 0x89, 0xC9, 0x29, 0xA9, 0x46, 0x00 }, //50
		{ 0x00, 0xE4, 0x8C, 0xC4, 0x24, 0xA4, 0x4E, 0x00 }, //51
		{ 0x00, 0xE6, 0x89, 0xC1, 0x22, 0xA4, 0x4F, 0x00 }, //52
		{ 0x00, 0xE6, 0x89, 0xC1, 0x22, 0xA1, 0x49, 0x06 }, //53
		{ 0x00, 0xEA, 0x8A, 0xCA, 0x2F, 0xA2, 0x42, 0x00 }, //54
		{ 0x00, 0xEE, 0x88, 0xCE, 0x21, 0xA9, 0x46, 0x00 }, //55
		{ 0x00, 0xEE, 0x88, 0xCE, 0x21, 0xA9, 0x46, 0x00 }, //56
		{ 0x00, 0xEF, 0x81, 0xC2, 0x22, 0xA4, 0x44, 0x00 }, //57
		{ 0x00, 0xE6, 0x89, 0xC9, 0x26, 0xA9, 0x49, 0x06 }, //58
		{ 0x00, 0xE6, 0x89, 0xC9, 0x27, 0xA1, 0x46, 0x00 }, //59
		};
void Delay_xms(uint x) {

	bcm2835_delay(x);

}

void Write_Max7219_byte(uchar DATA) {
	bcm2835_gpio_write(Max7219_pinCS, LOW);
	bcm2835_spi_transfer(DATA);
}
void Write_Max7219(uchar address1, uchar dat1, uchar address2, uchar dat2)
//void Write_Max7219(uchar address,uchar dat)
{
	bcm2835_gpio_write(Max7219_pinCS, LOW);

	Write_Max7219_byte(address1);
	Write_Max7219_byte(dat1);
	Write_Max7219_byte(address2);
	Write_Max7219_byte(dat2);
	//_nop_();
	//Write_Max7219_byte(address);
	//Write_Max7219_byte(dat);
	bcm2835_gpio_write(Max7219_pinCS, HIGH);
}
void Init_MAX7219() {
	Write_Max7219(0x09, 0x00, 0x09, 0x00);
	Write_Max7219(0x0a, 0x03, 0x0a, 0x03);
	Write_Max7219(0x0b, 0x07, 0x0b, 0x07);
	Write_Max7219(0x0c, 0x01, 0x0c, 0x01);
	Write_Max7219(0x0f, 0x00, 0x0f, 0x00);
}
int getHour() {
	time_t rawtime;
	time(&rawtime);
	struct tm *tm_struct = localtime(&rawtime);
	int hour = tm_struct->tm_hour;
	return hour;
}

int getMin() {
	time_t rawtime;
	time(&rawtime);
	struct tm *tm_struct = localtime(&rawtime);
	int min = tm_struct->tm_min;
	return min;
}
int main() {
	if (!bcm2835_init())
		return 1;
	uchar i, j;
	bcm2835_spi_begin();
	bcm2835_spi_setBitOrder(BCM2835_SPI_BIT_ORDER_MSBFIRST);      // The default
	bcm2835_spi_setDataMode(BCM2835_SPI_MODE0);                   // The default
	bcm2835_spi_setClockDivider(BCM2835_SPI_CLOCK_DIVIDER_256); // The default
	bcm2835_gpio_fsel(Max7219_pinCS, BCM2835_GPIO_FSEL_OUTP);

	bcm2835_gpio_write(left[i][j], HIGH);
	Delay_xms(50);
	Init_MAX7219();

	while (1) {
		int hour = getHour();
		if (hour > 12) {
			hour -= 12;
		}

		for (j = 0; j < 8; j++) {
			Write_Max7219(j + 1, right[getMin()][j], j + 1, left[hour - 1][j]);

		}
		Delay_xms(1000);
	
    		for (j = 0; j < 8; j++) {
			Write_Max7219(j + 1, right[getMin()][j], j + 1, leftB[hour - 1][j]);
            
        
		}Delay_xms(1000);
    }
	return 0;
}
